function ROI_Data = ImBat_RepairFlightData(ROI_Data);
% Repair flight data

n = 100; % minimum length of gap to repair:

GG = ROI_Data{1, 1}.Alignment.out.Location3(:,1);
Flights_Smoothed = ROI_Data{1, 1}.Alignment.out.Location3(:,:);
Flights_Original = ROI_Data{1, 1}.Alignment.out.Location(:,:);

figure(); plot(GG,'r');

GG2 = GG;
hold on;
% find stretches of zeros:
x = diff(smooth(GG,1));
transitions = diff([0; x == 0; 0]); %find where the array goes from non-zero to zero and vice versa
runstarts = find(transitions == 1);
runends = find(transitions == -1); %one past the end
runlengths = runends - runstarts;
%keep only those runs of length n or more:
runstarts(runlengths < n) = [];
runends(runlengths < n) = [];
%expand each run into a list indices:
indices = arrayfun(@(s, e) s:e-1, runstarts, runends, 'UniformOutput', false);
indices = [indices{:}];  %concatenate the list of indices into one vector
GG2(indices) = NaN; %replace the indices with 2
indices = [indices size(GG2,1)];
plot(GG2);

% replace zeros:
Flights_new = ROI_Data{1, 1}.Alignment.out.Location2(:,:);
Flights_new(indices,:) = Flights_Smoothed(indices,:);
figure(); hold on; plot(Flights_new(:,1)); plot(GG);

%% do it again:
clear transitions runstarts runends indices GG GG2;
GG = Flights_new(:,1);
GG2 = GG;
GG3 = GG;
% find stretches of zeros:
x = diff(smooth(GG,1));
n = 100; % length of zeros
transitions = diff([0; x == 0; 0]); %find where the array goes from non-zero to zero and vice versa
runstarts = find(transitions == 1);
runends = find(transitions == -1); %one past the end
runlengths = runends - runstarts;
%keep only those runs of length n or more:
runstarts(runlengths < n) = [];
runends(runlengths < n) = [];
%expand each run into a list indices:
indices = arrayfun(@(s, e) s:e-1, runstarts, runends, 'UniformOutput', false);
indices = [indices{:}];  %concatenate the list of indices into one vector
GG2(indices) = NaN; %replace the indices with 2
indices = [indices size(GG2,1)];


Flights_fixed = Flights_new;
% now, get rid of them..
hang1 = 1;%overhang
for i = 1: size(runstarts,1)
    % check which side is bigger:
    if runstarts(i) ==1;
        b = Flights_new(runends(i)+hang1,:);
        toUse = b;
        Flights_fixed(runstarts(i):runends(i)+hang1,:) = ones(size(runstarts(i):runends(i)+hang1,2),3).*toUse;
        
    elseif runends(i) > length(GG3)-hang1
        a = Flights_new(runstarts(i)-hang1,:);
        toUse = a;
        Flights_fixed(runstarts(i)-hang1:runends(i),:) = ones(size(runstarts(i)-hang:runends(i)+hang1,2),3).*toUse;
        
    else
        a = Flights_new(runstarts(i)-hang1,:);
        b = Flights_new(runends(i)+hang1,:);
        if a(:,1)>b(:,1); toUse = a;
        else
            toUse = b;
        end
        Flights_fixed(runstarts(i)-hang1:runends(i)+hang1,:) = toUse;
        
    end
end

Flights_fixed = smooth(Flights_fixed,50);

figure();
plot(Flights_Original(:,1));

plot(Flights_new(:,1));
plot(Flights_fixed(:,1));

 legend('original','smoothed','repaired');
 
 
 ROI_Data{1, 1}.Alignment.out.Flights_Repaired(:,1) = GG5;